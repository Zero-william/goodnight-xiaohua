﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="theme-color" content="#2196f3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="晚安小花">
    <meta name="description" content="智能闹钟管理系统">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <title>晚安小花</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-top: 80px;
        }
        
        /* 标签页导航 */
        .tab-navigation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: center;
            padding: 10px 20px;
        }
        
        .tab-nav-container {
            display: flex;
            gap: 10px;
            max-width: 600px;
            width: 100%;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: #f5f5f5;
            color: #666;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: #e0e0e0;
        }
        
        .tab-btn.active {
            background: #2196f3;
            color: white;
        }
        
        /* 标签页内容 */
        .tab-content {
            display: none;
            width: 100%;
            animation: fadeIn 0.3s ease-in;
            position: relative;
            z-index: 1;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
            text-align: center;
        }
        
        .app-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 20px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            position: relative;
        }
        
        /* 当前时间显示 */
        .current-time {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .current-time .time {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .current-time .next-alarm {
            font-size: 0.9em;
            color: #666;
        }
        
        /* 闹钟列表 */
        .alarm-list {
            margin-bottom: 80px;
        }
        
        .alarm-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alarm-info {
            flex: 1;
        }
        
        .alarm-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .alarm-details {
            font-size: 0.85em;
            color: #666;
        }
        
        /* 开关按钮 */
        .toggle-btn {
            position: relative;
            width: 50px;
            height: 26px;
            background: #e0e0e0;
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-btn.active {
            background: #2196f3;
        }
        
        .toggle-btn::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .toggle-btn.active::after {
            left: 26px;
        }
        
        /* 添加闹钟按钮 */
        .add-alarm-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #2196f3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .add-alarm-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(33, 150, 243, 0.5);
        }
        
        /* ESP32S3导入按钮 */
        .esp-import-btn {
            position: fixed;
            bottom: 160px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            text-align: center;
            padding: 10px;
        }
        
        .esp-import-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.5);
        }
        
        /* 套餐选择部分 */
        .packages-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto 80px;
        }
        
        .packages-title {
            color: #333;
            margin-bottom: 30px;
            font-size: 1.5em;
            text-align: center;
        }
        
        .packages-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .package-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            width: 300px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .package-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .package-card.recommended {
            border-color: #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .package-header {
            margin-bottom: 15px;
            position: relative;
        }
        
        .package-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .package-badge {
            display: inline-block;
            background: #2196f3;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .recommended-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .package-content {
            margin-bottom: 20px;
        }
        
        .package-description {
            font-size: 1em;
            color: #666;
            margin-bottom: 15px;
        }
        
        .package-features {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .package-features li {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .package-features li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: #2196f3;
            font-weight: bold;
        }
        
        /* 步骤项样式 */
        .step-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .step-info {
            flex: 1;
        }
        
        .step-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .step-details {
            font-size: 0.85em;
            color: #666;
        }
        
        /* 视频容器样式 */
        .video-container {
            margin: 20px auto;
            width: 100%;
            max-width: 1200px;
        }
        
        .video-container h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .video-placeholder {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        
        /* 无闹钟提示样式 */
        .no-alarms-message {
            text-align: center;
            padding: 60px 40px;
            background: #f0f8ff;
            border: 2px dashed #2196f3;
            border-radius: 12px;
            color: #333;
            font-size: 1.1em;
            margin-top: 30px;
            margin-bottom: 30px;
            z-index: 1000;
            position: relative;
        }
        
        .package-btn {
            width: 100%;
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .package-btn:hover {
            background: #1976d2;
        }
        
        .package-card.recommended .package-btn {
            background: #2196f3;
            color: white;
        }
        
        .package-card.recommended .package-btn:hover {
            background: #1976d2;
        }
        
        /* 添加闹钟弹窗 */
        .add-alarm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
        }
        
        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        input[type="text"],
        input[type="time"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: #f9f9f9;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cancel-btn {
            background: #f5f5f5;
            color: #333;
        }
        
        .save-btn {
            background: #2196f3;
            color: white;
        }
        
        .save-btn:hover {
            background: #1976d2;
        }
        
        /* 套餐步骤显示区域 */
        .package-steps-container {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 12px;
        }
        
        .package-steps-container h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .package-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .step-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            font-size: 0.9em;
            color: #333;
        }
        
        .start-package-btn {
            width: 100%;
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .start-package-btn:hover {
            background: #1976d2;
        }
        
        /* 桌面设备特定样式 */
        .desktop-device .app-container {
            max-width: 500px;
            margin: 0 auto 30px;
        }
        
        .desktop-device .packages-section {
            max-width: 1400px;
        }
        
        .desktop-device .packages-container {
            gap: 30px;
        }
        
        .desktop-device .package-card {
            width: 350px;
        }
        
        .desktop-device .video-container {
            max-width: 1400px;
        }
        
        .desktop-device video {
            height: 600px;
        }
        
        /* 桌面端按钮位置优化 */
        .desktop-device .add-alarm-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            font-size: 2.5em;
        }
        
        .desktop-device .esp-import-btn {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 90px;
            height: 90px;
            font-size: 1.2em;
        }
        
        /* 桌面端悬停效果 */
        .desktop-device .add-alarm-btn:hover,
        .desktop-device .esp-import-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.6);
        }
        
        /* 桌面端弹窗优化 */
        .desktop-device .modal-content {
            max-width: 400px;
            padding: 35px;
        }
        
        /* 桌面端滚动条美化 */
        .desktop-device ::-webkit-scrollbar {
            width: 10px;
        }
        
        .desktop-device ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        
        .desktop-device ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        
        .desktop-device ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 暗黑模式下的滚动条 */
        @media (prefers-color-scheme: dark) {
            .desktop-device ::-webkit-scrollbar-track {
                background: #2d2d2d;
            }
            
            .desktop-device ::-webkit-scrollbar-thumb {
                background: #555;
            }
            
            .desktop-device ::-webkit-scrollbar-thumb:hover {
                background: #777;
            }
        }
        
        /* 打卡日历样式 */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        
        #calendar-grid > div {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #calendar-grid > div:hover {
            background: #e3f2fd;
            transform: scale(1.05);
        }
        
        /* 移动端打卡日历优化 */
        @media (max-width: 768px) {
            /* 日历网格优化 */
            #calendar-grid {
                gap: 5px !important;
            }
            
            #calendar-grid > div {
                min-height: 45px !important;
                padding: 8px !important;
                font-size: 0.9em !important;
            }
            
            /* 日历导航优化 */
            #calendar-nav {
                margin-bottom: 15px !important;
            }
            
            #current-month {
                font-size: 1.1em !important;
            }
            
            /* 星期标题优化 */
            #weekdays {
                gap: 5px !important;
                margin-bottom: 8px !important;
            }
            
            #weekdays > div {
                font-size: 0.8em !important;
                padding: 5px 0 !important;
            }
            
            /* 打卡统计优化 */
            #checkin-stats {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            #checkin-stats > div {
                padding: 12px !important;
            }
            
            /* 今日状态优化 */
            #today-status {
                margin-top: 20px !important;
                padding: 15px !important;
            }
            
            #checkin-btn {
                padding: 10px 25px !important;
                font-size: 0.9em !important;
            }
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 100px;
                padding-top: 80px;
            }
            
            /* 移动端标签页导航优化 */
            .tab-navigation {
                padding: 8px 10px;
            }
            
            .tab-nav-container {
                gap: 5px;
            }
            
            .tab-btn {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .app-container,
            .packages-section {
                padding: 15px;
            }
            
            .current-time .time {
                font-size: 2em;
            }
            
            .alarm-time {
                font-size: 1.3em;
            }
            
            /* 移动端按钮优化 */
            .add-alarm-btn {
                width: 56px;
                height: 56px;
                bottom: 70px;
                right: 15px;
            }
            
            .esp-import-btn {
                width: 70px;
                height: 70px;
                bottom: 140px;
                right: 15px;
                font-size: 0.9em;
            }
            
            /* 移动端视频优化 */
            video {
                height: 300px;
            }
            
            /* 移动端套餐卡片优化 */
            .package-card {
                width: 100%;
                min-width: 280px;
            }
            
            /* 移动端弹窗优化 */
            .modal-content {
                width: 95%;
                max-width: 320px;
                padding: 20px;
            }
            
            /* 移动端触摸优化 */
            .toggle-btn,
            .package-btn,
            .modal-btn,
            .add-alarm-btn,
            .esp-import-btn,
            .tab-btn {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* 移动端滚动优化 */
            body {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior-y: contain;
            }
        }
        
        /* 移动端特定优化 */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }
            
            .current-time .time {
                font-size: 1.8em;
            }
            
            .alarm-time {
                font-size: 1.2em;
            }
            
            .alarm-details {
                font-size: 0.8em;
            }
            
            .package-name {
                font-size: 1.1em;
            }
            
            .package-description {
                font-size: 0.9em;
            }
            
            .package-features li {
                font-size: 0.85em;
            }
            
            /* 更小的移动端按钮 */
            .add-alarm-btn {
                width: 50px;
                height: 50px;
                bottom: 65px;
                right: 10px;
            }
            
            .esp-import-btn {
                width: 60px;
                height: 60px;
                bottom: 125px;
                right: 10px;
                font-size: 0.8em;
            }
        }
        
        /* 横屏模式优化 */
        @media (orientation: landscape) and (max-height: 500px) {
            .app-container {
                margin-bottom: 10px;
            }
            
            .packages-section {
                margin-bottom: 10px;
            }
            
            .add-alarm-btn {
                bottom: 10px;
            }
            
            .esp-import-btn {
                bottom: 75px;
            }
        }
        
        /* 暗黑模式支持 */
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
                color: #e0e0e0;
            }
            
            .app-container,
            .packages-section,
            .alarm-item,
            .package-card,
            .modal-content,
            .step-item {
                background: #2d2d2d;
                color: #e0e0e0;
            }
            
            h1,
            .packages-title,
            .package-name,
            .alarm-time,
            .modal-title {
                color: #e0e0e0;
            }
            
            .alarm-details,
            .package-description,
            .package-features li,
            .step-details {
                color: #b0b0b0;
            }
            
            .no-alarms-message {
                background: #1e3a5f;
                border-color: #2196f3;
                color: #e0e0e0;
            }
            
            input[type="text"],
            input[type="time"],
            select {
                background: #3d3d3d;
                border-color: #4d4d4d;
                color: #e0e0e0;
            }
            
            .cancel-btn {
            background: #3d3d3d;
            color: #e0e0e0;
        }
        
        /* 触摸设备激活状态 */
        .touch-active {
            opacity: 0.7 !important;
            transform: scale(0.95);
        }
        
        /* 移动端安全区域适配 */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                padding-bottom: max(100px, env(safe-area-inset-bottom));
            }
            
            .add-alarm-btn {
                right: max(15px, env(safe-area-inset-right));
                bottom: max(70px, env(safe-area-inset-bottom));
            }
            
            .esp-import-btn {
                right: max(15px, env(safe-area-inset-right));
                bottom: max(140px, env(safe-area-inset-bottom));
            }
        }
        }
        
        /* 自定义提示框样式 */
        .custom-alert {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .custom-alert.active {
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }
        
        .alert-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            animation: slideUp 0.3s ease-out forwards;
        }
        
        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }
        
        .alert-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .alert-message {
            font-size: 1em;
            color: #666;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.4;
        }
        
        .alert-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .alert-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        
        .alert-btn.primary {
            background: #2196f3;
            color: white;
        }
        
        .alert-btn.primary:hover {
            background: #1976d2;
            transform: translateY(-2px);
        }
        
        .alert-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .alert-btn.secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        /* 暗黑模式下的提示框 */
        @media (prefers-color-scheme: dark) {
            .alert-content {
                background: #2d2d2d;
                color: #e0e0e0;
            }
            
            .alert-title {
                color: #e0e0e0;
            }
            
            .alert-message {
                color: #b0b0b0;
            }
            
            .alert-btn.secondary {
                background: #3d3d3d;
                color: #e0e0e0;
            }
            
            .alert-btn.secondary:hover {
                background: #4d4d4d;
            }
        }
        
        /* 移动端提示框优化 */
        @media (max-width: 768px) {
            .alert-content {
                width: 95%;
                max-width: 320px;
                padding: 20px;
            }
            
            .alert-title {
                font-size: 1.1em;
            }
            
            .alert-message {
                font-size: 0.9em;
            }
            
            .alert-btn {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
        
        /* 锁屏界面样式 */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            margin: 0;
            padding: 0;
            border: none;
            overflow: hidden;
            box-shadow: none;
            outline: none;
            width: 100%;
            height: 100%;
        }
        
        /* 确保锁屏界面在所有元素之上 */
        .lock-screen.active {
            display: flex;
            animation: fadeIn 0.5s ease-in;
            position: fixed !important;
            z-index: 99999 !important;
        }
        
        /* 确保锁屏内容也在最上层 */
        .lock-content {
            position: relative;
            z-index: 99999;
        }
        
        .lock-screen.active {
            display: flex;
            animation: fadeIn 0.5s ease-in;
        }
        
        .lock-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            animation: slideUp 0.5s ease-out forwards;
        }
        
        .lock-emoji {
            font-size: 4em;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }
        
        .lock-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .lock-message {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.4;
        }
        
        .lock-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .lock-btn {
            padding: 14px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .lock-btn.primary {
            background: #2196f3;
            color: white;
        }
        
        .lock-btn.primary:hover {
            background: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .lock-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .lock-btn.secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        /* 暗黑模式下的锁屏界面 */
        @media (prefers-color-scheme: dark) {
            .lock-content {
                background: #2d2d2d;
                color: #e0e0e0;
            }
            
            .lock-title {
                color: #e0e0e0;
            }
            
            .lock-message {
                color: #b0b0b0;
            }
            
            .lock-btn.secondary {
                background: #3d3d3d;
                color: #e0e0e0;
            }
            
            .lock-btn.secondary:hover {
                background: #4d4d4d;
            }
        }
        
        /* 移动端锁屏优化 */
        @media (max-width: 768px) {
            .lock-content {
                width: 95%;
                max-width: 320px;
                padding: 30px 20px;
            }
            
            .lock-emoji {
                font-size: 3em;
                margin-bottom: 15px;
            }
            
            .lock-title {
                font-size: 1.5em;
            }
            
            .lock-message {
                font-size: 1em;
                margin-bottom: 25px;
            }
            
            .lock-btn {
                padding: 12px 24px;
                font-size: 14px;
                min-width: 90px;
            }
        }
    </style>
</head>
<body>
    <!-- 标签页导航 -->
    <div class="tab-navigation">
        <div class="tab-nav-container">
            <button class="tab-btn active" onclick="switchTab('software')">晚安小花</button>

            <button class="tab-btn" onclick="switchTab('checkin')">打卡</button>

        </div>
    </div>
    
    <!-- 软件网页标签页 -->
    <div id="software-tab" class="tab-content active">
        <h1>晚安小花</h1>
    
    <!-- 设备信息提示 -->
    <div id="device-info" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
        <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 8px;">
            <span id="device-icon">💻</span> <span id="device-type">桌面版</span>
        </div>
        <div style="font-size: 0.9em; opacity: 0.9;">
            <span id="device-tip">您正在使用桌面浏览器访问，享受大屏幕体验</span>
        </div>
        <button onclick="closeDeviceInfo()" style="margin-top: 10px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">知道了</button>
    </div>
    
    <!-- 主应用容器 -->
    <div class="app-container">
        <!-- 当前时间显示 -->
        <div class="current-time">
            <div class="time" id="current-time">14:26:25</div>
            <div class="next-alarm" id="next-alarm">Ring in 16 hours 3 minutes</div>
        </div>
        
        <!-- 闹钟列表 -->
        <div class="alarm-list" id="alarm-list">
            <!-- 闹钟项将显示在这里 -->
        </div>
    </div>
    
    <!-- 套餐选择部分 -->
    <div class="packages-section">
        <h2 class="packages-title">选择套餐</h2>
        <div class="packages-container">
            <div class="package-card">
                <div class="package-header">
                    <h3 class="package-name">超累也能做</h3>
                    <div class="package-badge">5分钟</div>
                </div>
                <div class="package-content">
                    <p class="package-description">5分钟快速放松</p>
                    <ul class="package-features">
                        <li>明天三件事（1分钟）</li>
                        <li>呼吸节律（3分钟）</li>
                        <li>关灯上床（1分钟）</li>
                    </ul>
                    <button class="package-btn" onclick="selectPackage('package1')">选择</button>
                </div>
            </div>
            
            <div class="package-card recommended">
                <div class="package-header">
                    <h3 class="package-name">考前焦虑</h3>
                    <div class="package-badge">10分钟</div>
                    <div class="recommended-badge">推荐</div>
                </div>
                <div class="package-content">
                    <p class="package-description">10分钟缓解焦虑</p>
                    <ul class="package-features">
                        <li>焦虑排水（5分钟）</li>
                        <li>渐进式放松（4分钟）</li>
                        <li>身体扫描（1分钟）</li>
                    </ul>
                    <button class="package-btn" onclick="selectPackage('package2')">选择</button>
                </div>
            </div>
            
            <div class="package-card">
                <div class="package-header">
                    <h3 class="package-name">睡眠质量</h3>
                    <div class="package-badge">15分钟</div>
                </div>
                <div class="package-content">
                    <p class="package-description">15分钟深度放松</p>
                    <ul class="package-features">
                        <li>桌面清空（1分钟）</li>
                        <li>伸展3动作（5分钟）</li>
                        <li>白噪音（10分钟）</li>
                    </ul>
                    <button class="package-btn" onclick="selectPackage('package3')">选择</button>
                </div>
            </div>
            
            <div class="package-card">
                <div class="package-header">
                    <h3 class="package-name">拉伸放松</h3>
                    <div class="package-badge">8分钟</div>
                </div>
                <div class="package-content">
                    <p class="package-description">8分钟全身放松</p>
                    <ul class="package-features">
                        <li>颈部拉伸（2分钟）</li>
                        <li>肩部放松（2分钟）</li>
                        <li>深呼吸（4分钟）</li>
                    </ul>
                    <button class="package-btn" onclick="selectPackage('package4')">选择</button>
                </div>
            </div>
        </div>
    </div>
    
    
    
    <!-- 添加闹钟按钮 -->
    <div class="add-alarm-btn" id="add-alarm-btn">+</div>
    
    <!-- ESP32S3导入按钮 -->
    <div class="esp-import-btn" id="esp-import-btn">一键导入</div>
    
    <!-- 停止音乐播放按钮 -->
    <div class="esp-import-btn" style="bottom: 240px; background: #f44336;" onclick="stopMusicPlayback()">停止播放</div>
    
    <!-- 添加闹钟弹窗 -->
    <div class="add-alarm-modal" id="add-alarm-modal">
        <div class="modal-content">
            <div class="modal-title">添加闹钟</div>
            <div class="form-group">
                <label for="reminder-content">提醒内容</label>
                <input type="text" id="reminder-content" placeholder="请输入提醒内容，例如：睡觉">
            </div>
            <div class="form-group">
                <label for="reminder-time">提醒时间</label>
                <div style="display: flex; gap: 10px;">
                    <select id="reminder-hours" style="flex: 1;">
                        <option value="00">00</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                    </select>
                    <select id="reminder-minutes" style="flex: 1;">
                        <option value="00">00</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                        <option value="32">32</option>
                        <option value="33">33</option>
                        <option value="34">34</option>
                        <option value="35">35</option>
                        <option value="36">36</option>
                        <option value="37">37</option>
                        <option value="38">38</option>
                        <option value="39">39</option>
                        <option value="40">40</option>
                        <option value="41">41</option>
                        <option value="42">42</option>
                        <option value="43">43</option>
                        <option value="44">44</option>
                        <option value="45">45</option>
                        <option value="46">46</option>
                        <option value="47">47</option>
                        <option value="48">48</option>
                        <option value="49">49</option>
                        <option value="50">50</option>
                        <option value="51">51</option>
                        <option value="52">52</option>
                        <option value="53">53</option>
                        <option value="54">54</option>
                        <option value="55">55</option>
                        <option value="56">56</option>
                        <option value="57">57</option>
                        <option value="58">58</option>
                        <option value="59">59</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="voice-type">语音类型</label>
                <select id="voice-type">
                    <option value="male">男声</option>
                    <option value="female">女声</option>
                </select>
            </div>
            <div class="form-group">
                <label for="music-duration">定时关闭</label>
                <div style="display: flex; gap: 10px;">
                    <select id="music-hours" style="flex: 1;">
                        <option value="00">00</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                    </select>
                    <select id="music-minutes" style="flex: 1;">
                        <option value="00">00</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                        <option value="32">32</option>
                        <option value="33">33</option>
                        <option value="34">34</option>
                        <option value="35">35</option>
                        <option value="36">36</option>
                        <option value="37">37</option>
                        <option value="38">38</option>
                        <option value="39">39</option>
                        <option value="40">40</option>
                        <option value="41">41</option>
                        <option value="42">42</option>
                        <option value="43">43</option>
                        <option value="44">44</option>
                        <option value="45">45</option>
                        <option value="46">46</option>
                        <option value="47">47</option>
                        <option value="48">48</option>
                        <option value="49">49</option>
                        <option value="50">50</option>
                        <option value="51">51</option>
                        <option value="52">52</option>
                        <option value="53">53</option>
                        <option value="54">54</option>
                        <option value="55">55</option>
                        <option value="56">56</option>
                        <option value="57">57</option>
                        <option value="58">58</option>
                        <option value="59">59</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="repeat-option">重复</label>
                <div id="repeat-container" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                    <div id="repeat-display" style="color: #666; cursor: pointer;" onclick="toggleRepeatDays()">点击选择重复日期</div>
                    <div id="repeat-days" style="display: none; margin-top: 10px; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px;" onclick="event.stopPropagation()">
                            <input type="checkbox" value="1" class="repeat-day" onchange="updateRepeatDisplay()"> 一
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px;" onclick="event.stopPropagation()">
                            <input type="checkbox" value="2" class="repeat-day" onchange="updateRepeatDisplay()"> 二
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px;" onclick="event.stopPropagation()">
                            <input type="checkbox" value="3" class="repeat-day" onchange="updateRepeatDisplay()"> 三
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px;" onclick="event.stopPropagation()">
                            <input type="checkbox" value="4" class="repeat-day" onchange="updateRepeatDisplay()"> 四
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px;" onclick="event.stopPropagation()">
                            <input type="checkbox" value="5" class="repeat-day" onchange="updateRepeatDisplay()"> 五
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px;" onclick="event.stopPropagation()">
                            <input type="checkbox" value="6" class="repeat-day" onchange="updateRepeatDisplay()"> 六
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px;" onclick="event.stopPropagation()">
                            <input type="checkbox" value="0" class="repeat-day" onchange="updateRepeatDisplay()"> 日
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel-btn" id="cancel-btn">取消</button>
                <button class="modal-btn save-btn" id="save-btn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 套餐时间选择弹窗 -->
    <div class="add-alarm-modal" id="package-time-modal">
        <div class="modal-content">
            <div class="modal-title">选择时间</div>
            <div class="form-group">
                <label for="package-content">套餐内容</label>
                <input type="text" id="package-content" readonly>
            </div>
            <div class="form-group">
                <label for="package-time">您打算何时做？</label>
                <div style="display: flex; gap: 10px;">
                    <select id="package-hours" style="flex: 1;">
                        <option value="00">00</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                    </select>
                    <select id="package-minutes" style="flex: 1;">
                        <option value="00">00</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                        <option value="32">32</option>
                        <option value="33">33</option>
                        <option value="34">34</option>
                        <option value="35">35</option>
                        <option value="36">36</option>
                        <option value="37">37</option>
                        <option value="38">38</option>
                        <option value="39">39</option>
                        <option value="40">40</option>
                        <option value="41">41</option>
                        <option value="42">42</option>
                        <option value="43">43</option>
                        <option value="44">44</option>
                        <option value="45">45</option>
                        <option value="46">46</option>
                        <option value="47">47</option>
                        <option value="48">48</option>
                        <option value="49">49</option>
                        <option value="50">50</option>
                        <option value="51">51</option>
                        <option value="52">52</option>
                        <option value="53">53</option>
                        <option value="54">54</option>
                        <option value="55">55</option>
                        <option value="56">56</option>
                        <option value="57">57</option>
                        <option value="58">58</option>
                        <option value="59">59</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel-btn" id="package-cancel-btn">取消</button>
                <button class="modal-btn save-btn" id="package-confirm-btn">确认</button>
            </div>
        </div>
    </div>
    
    <audio id="audio-player" loop>
        <source src="" type="audio/mp4">
        <source src="" type="audio/x-m4a">
        <source src="" type="audio/mpeg">
        </audio>
    
    <!-- 自定义提示框 -->
    <div class="custom-alert" id="custom-alert">
        <div class="alert-content">
            <div class="alert-title" id="alert-title">提示</div>
            <div class="alert-message" id="alert-message">消息内容</div>
            <div class="alert-actions" id="alert-actions">
                <button class="alert-btn secondary" id="alert-cancel">取消</button>
                <button class="alert-btn primary" id="alert-confirm">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 锁屏界面 -->
    <div class="lock-screen" id="lock-screen">
        <div class="lock-content">
            <div class="lock-emoji" id="lock-screen-emoji">⏰</div>
            <h2 class="lock-title" id="lock-screen-title">时间到了</h2>
            <p class="lock-message" id="lock-screen-message">休息一下吧</p>
            <div class="lock-actions">
                <button class="lock-btn primary" id="lock-screen-exit-btn" onclick="hideLockScreen()">退出</button>
            </div>
        </div>
    </div>
    
    
    
    <script>
        // 设备检测
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        console.log('设备信息:', {
            isMobile: isMobile,
            isTouchDevice: isTouchDevice,
            userAgent: navigator.userAgent,
            screenWidth: window.innerWidth,
            screenHeight: window.innerHeight
        });
        
        // 根据设备类型添加特定样式
        if (isMobile) {
            document.body.classList.add('mobile-device');
            console.log('检测到移动设备');
            
            // 显示移动设备提示
            showDeviceInfo('mobile');
        } else {
            document.body.classList.add('desktop-device');
            console.log('检测到桌面设备');
            
            // 显示桌面设备提示
            showDeviceInfo('desktop');
        }
        
        if (isTouchDevice) {
            document.body.classList.add('touch-device');
        }
        
        // 显示设备信息提示
        function showDeviceInfo(deviceType) {
            const deviceInfo = document.getElementById('device-info');
            const deviceIcon = document.getElementById('device-icon');
            const deviceTypeText = document.getElementById('device-type');
            const deviceTip = document.getElementById('device-tip');
            
            if (deviceType === 'mobile') {
                deviceIcon.textContent = '📱';
                deviceTypeText.textContent = '手机版';
                deviceTip.textContent = '您可以添加到主屏幕，获得更好的使用体验';
            } else {
                deviceIcon.textContent = '💻';
                deviceTypeText.textContent = '桌面版';
                deviceTip.textContent = '您正在使用桌面浏览器访问，享受大屏幕体验';
            }
            
            // 显示提示（延迟显示，避免页面加载时闪烁）
            setTimeout(() => {
                deviceInfo.style.display = 'block';
                deviceInfo.style.animation = 'fadeIn 0.5s ease-in';
            }, 500);
            
            // 5秒后自动关闭
            setTimeout(() => {
                closeDeviceInfo();
            }, 5000);
        }
        
        // 关闭设备信息提示
        function closeDeviceInfo() {
            const deviceInfo = document.getElementById('device-info');
            if (deviceInfo) {
                deviceInfo.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    deviceInfo.style.display = 'none';
                }, 300);
            }
        }
        
        // 添加淡入淡出动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-10px); }
            }
        `;
        document.head.appendChild(style);
        
        // Service Worker 注册
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }
        
        // 音乐列表
        const musicList = [
            { title: "背景音乐 1", url: "music/audio(1).m4s" },
            { title: "背景音乐 2", url: "music/audio(3).m4s" },
            { title: "背景音乐 3", url: "music/audio(5).m4s" }
        ];
        
        let currentMusicIndex = 0;
        let alarms = []; // 初始为空，无闹钟
        let isPlaying = false;
        let alarmIdCounter = 0;
        
        // DOM 元素
        const reminderContent = document.getElementById('reminder-content');
        const reminderHours = document.getElementById('reminder-hours');
        const reminderMinutes = document.getElementById('reminder-minutes');
        const voiceType = document.getElementById('voice-type');
        const musicHours = document.getElementById('music-hours');
        const musicMinutes = document.getElementById('music-minutes');
        const alarmList = document.getElementById('alarm-list');
        const audioPlayer = document.getElementById('audio-player');
        const addAlarmBtn = document.getElementById('add-alarm-btn');
        const addAlarmModal = document.getElementById('add-alarm-modal');
        const saveBtn = document.getElementById('save-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const currentTimeDisplay = document.getElementById('current-time');
        const nextAlarmDisplay = document.getElementById('next-alarm');
        
        // 重复日期复选框事件监听
        const repeatCheckboxes = document.querySelectorAll('.repeat-day');
        repeatCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateRepeatDisplay);
        });
        
        // 套餐时间选择弹窗元素
        const packageTimeModal = document.getElementById('package-time-modal');
        const packageContentInput = document.getElementById('package-content');
        const packageHours = document.getElementById('package-hours');
        const packageMinutes = document.getElementById('package-minutes');
        const packageCancelBtn = document.getElementById('package-cancel-btn');
        const packageConfirmBtn = document.getElementById('package-confirm-btn');
        
        // 存储当前套餐信息
        let currentPackage = {
            id: '',
            content: '',
            durationMinutes: 0,
            steps: []
        }; // 初始为空，无套餐
        
        // 音乐定时关闭计时器
        let musicTimer = null;
        
        // 套餐步骤信息
        const packageSteps = {
            package1: [
                { name: '明天三件事', duration: 1 }, // 1分钟
                { name: '呼吸节律', duration: 3 }, // 3分钟
                { name: '关灯上床', duration: 1 }  // 1分钟
            ],
            package2: [
                { name: '焦虑排水', duration: 5 }, // 5分钟
                { name: '渐进式放松', duration: 4 }, // 4分钟
                { name: '身体扫描', duration: 1 }  // 1分钟
            ],
            package3: [
                { name: '桌面清空', duration: 1 }, // 1分钟
                { name: '伸展3动作', duration: 5 }, // 5分钟
                { name: '白噪音', duration: 10 }  // 10分钟
            ],
            package4: [
                { name: '颈部拉伸', duration: 2 }, // 2分钟
                { name: '肩部放松', duration: 2 }, // 2分钟
                { name: '深呼吸', duration: 4 }  // 4分钟
            ]
        };
        
        // 显示/隐藏重复日期选择
        function toggleRepeatDays() {
            const repeatDays = document.getElementById('repeat-days');
            if (repeatDays.style.display === 'none') {
                repeatDays.style.display = 'flex';
            } else {
                repeatDays.style.display = 'none';
            }
        }
        
        // 更新重复日期显示
        function updateRepeatDisplay() {
            const checkboxes = document.querySelectorAll('.repeat-day');
            const selectedDays = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
                    selectedDays.push(dayNames[parseInt(checkbox.value)]);
                }
            });
            
            const repeatDisplay = document.getElementById('repeat-display');
            if (selectedDays.length === 0) {
                repeatDisplay.textContent = '点击选择重复日期';
                repeatDisplay.style.color = '#666';
            } else {
                repeatDisplay.textContent = '已选择: ' + selectedDays.join(', ');
                repeatDisplay.style.color = '#2196f3';
            }
        }
        
        // 获取选中的重复日期
        function getSelectedRepeatDays() {
            const checkboxes = document.querySelectorAll('.repeat-day');
            const selectedDays = [];
            checkboxes.forEach(checkbox => {
                console.log('复选框:', checkbox.value, '选中状态:', checkbox.checked);
                if (checkbox.checked) {
                    selectedDays.push(parseInt(checkbox.value));
                }
            });
            console.log('返回的重复日期:', selectedDays);
            return selectedDays;
        }
        
        // 清空重复日期选择
        function clearRepeatDays() {
            const checkboxes = document.querySelectorAll('.repeat-day');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateRepeatDisplay();
        }
        
        // 实时更新当前时间
        function updateCurrentTime() {
            // 强制获取最新的系统时间
            const now = new Date(Date.now());
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            currentTimeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
            
            // 更新下一个闹钟信息
            updateNextAlarmInfo();
        }
        
        // 更新下一个闹钟信息
        function updateNextAlarmInfo() {
            if (alarms.length === 0) {
                nextAlarmDisplay.textContent = 'No alarms set';
                // 显示没有闹钟的提示
                const alarmList = document.getElementById('alarm-list');
                if (alarmList) {
                    alarmList.innerHTML = '<div class="no-alarms-message">暂无闹钟，请点击下方按钮添加</div>';
                }
                return;
            }
            
            // 找到下一个要触发的闹钟
            const now = new Date();
            let nextAlarm = null;
            let minDiff = Infinity;
            
            alarms.forEach(alarm => {
                if (alarm.active) {
                    const diff = alarm.targetTime - now;
                    if (diff > 0 && diff < minDiff) {
                        minDiff = diff;
                        nextAlarm = alarm;
                    }
                }
            });
            
            if (nextAlarm) {
                const hours = Math.floor(minDiff / (1000 * 60 * 60));
                const minutes = Math.floor((minDiff % (1000 * 60 * 60)) / (1000 * 60));
                nextAlarmDisplay.textContent = `Ring in ${hours} hours ${minutes} minutes`;
            } else {
                nextAlarmDisplay.textContent = 'No active alarms';
            }
        }
        
        // 打开添加闹钟弹窗
        addAlarmBtn.addEventListener('click', function() {
            addAlarmModal.style.display = 'flex';
        });
        
        // 关闭弹窗
        cancelBtn.addEventListener('click', function() {
            addAlarmModal.style.display = 'none';
            // 清空表单
            reminderContent.value = '';
            reminderHours.value = '00';
            reminderMinutes.value = '00';
            voiceType.value = 'male';
            musicHours.value = '00';
            musicMinutes.value = '00';
            
            // 清空重复日期选择
            clearRepeatDays();
            
            // 清空已选择的套餐
            currentPackage = {
                id: '',
                content: '',
                durationMinutes: 0,
                steps: []
            };
            
            // 移除步骤容器
            const stepsContainer = document.getElementById('steps-container');
            if (stepsContainer && stepsContainer.parentNode) {
                stepsContainer.parentNode.removeChild(stepsContainer);
            }
            
            // 隐藏重复日期选择区域
            const repeatDays = document.getElementById('repeat-days');
            if (repeatDays) {
                repeatDays.style.display = 'none';
            }
        });
        
        // 保存闹钟
        saveBtn.addEventListener('click', function() {
            const content = reminderContent.value.trim();
            const hours = reminderHours.value;
            const minutes = reminderMinutes.value;
            const time = `${hours}:${minutes}`;
            const voice = voiceType.value;
            const musicHoursVal = musicHours.value;
            const musicMinutesVal = musicMinutes.value;
            const duration = (parseInt(musicHoursVal) * 60 + parseInt(musicMinutesVal)) * 60 * 1000; // 转换为毫秒
            
            // 获取重复日期
            const repeatDays = getSelectedRepeatDays();
            console.log('选中的重复日期:', repeatDays);
            
            if (!content) {
                alert('请输入提醒内容');
                return;
            }
            
            // 如果有重复日期，只创建一个闹钟，但在repeatDays中保存所有选中的日期
            if (repeatDays.length > 0) {
                // 计算目标时间（设置为最近的下一个重复日期）
                const now = new Date();
                const targetTime = new Date();
                targetTime.setHours(parseInt(hours));
                targetTime.setMinutes(parseInt(minutes));
                targetTime.setSeconds(0);
                
                // 找到下一个匹配的星期几
                let daysChecked = 0;
                while (!repeatDays.includes(targetTime.getDay()) && daysChecked < 8) {
                    targetTime.setDate(targetTime.getDate() + 1);
                    daysChecked++;
                }
                
                // 如果目标时间已过，设置为下周
                if (targetTime < now) {
                    targetTime.setDate(targetTime.getDate() + 7);
                }
                
                console.log('重复闹钟目标时间:', targetTime, '星期:', targetTime.getDay());
                
                // 创建新的闹钟（只创建一个）
                const alarmId = ++alarmIdCounter;
                const alarmItem = {
                    id: alarmId,
                    content: content,
                    time: time,
                    voice: voice,
                    duration: duration,
                    hours: parseInt(musicHoursVal),
                    minutes: parseInt(musicMinutesVal),
                    targetTime: targetTime,
                    interval: null,
                    active: true,
                    steps: currentPackage.steps || [],
                    repeatDays: repeatDays // 保存所有重复日期
                };
                
                // 添加到闹钟列表
                alarms.push(alarmItem);
                
                // 创建DOM元素
                createAlarmElement(alarmItem);
                
                // 开始倒计时
                startAlarm(alarmItem);
            } else {
                // 计算目标时间（不重复）
                const now = new Date();
                const targetTime = new Date();
                targetTime.setHours(parseInt(hours));
                targetTime.setMinutes(parseInt(minutes));
                targetTime.setSeconds(0);
                
                // 如果目标时间已过，设置为明天
                if (targetTime < now) {
                    targetTime.setDate(targetTime.getDate() + 1);
                }
                
                // 创建新的闹钟
                const alarmId = ++alarmIdCounter;
                const alarmItem = {
                    id: alarmId,
                    content: content,
                    time: time,
                    voice: voice,
                    duration: duration,
                    hours: parseInt(musicHoursVal),
                    minutes: parseInt(musicMinutesVal),
                    targetTime: targetTime,
                    interval: null,
                    active: true,
                    steps: currentPackage.steps || [],
                    repeatDays: [] // 不重复
                };
                
                // 添加到闹钟列表
                alarms.push(alarmItem);
                
                // 创建DOM元素
                createAlarmElement(alarmItem);
                
                // 开始倒计时
                startAlarm(alarmItem);
            }
            
            // 关闭弹窗并清空表单
            addAlarmModal.style.display = 'none';
            reminderContent.value = '';
            reminderHours.value = '00';
            reminderMinutes.value = '00';
            voiceType.value = 'male';
            musicHours.value = '00';
            musicMinutes.value = '00';
            
            // 清空重复日期选择
            clearRepeatDays();
            
            // 清空套餐
            currentPackage = {
                id: '',
                content: '',
                durationMinutes: 0,
                steps: []
            };
            
            // 移除步骤容器
            const stepsContainer = document.getElementById('steps-container');
            if (stepsContainer && stepsContainer.parentNode) {
                stepsContainer.parentNode.removeChild(stepsContainer);
            }
            
            // 更新下一个闹钟信息
            updateNextAlarmInfo();
        });
        
        // 创建闹钟DOM元素
        function createAlarmElement(alarmItem) {
            // 清除没有闹钟的提示
            if (alarmList.querySelector('.no-alarms-message')) {
                alarmList.innerHTML = '';
            }
            
            const alarmElement = document.createElement('div');
            alarmElement.className = 'alarm-item';
            alarmElement.id = `alarm-${alarmItem.id}`;
            
            // 格式化定时关闭时间
            let durationText = '不自动关闭';
            if (alarmItem.duration > 0) {
                const hours = alarmItem.hours;
                const minutes = alarmItem.minutes;
                if (hours > 0 && minutes > 0) {
                    durationText = `${hours}小时${minutes}分钟后关闭`;
                } else if (hours > 0) {
                    durationText = `${hours}小时后关闭`;
                } else {
                    durationText = `${minutes}分钟后关闭`;
                }
            }
            
            // 格式化重复日期
            let repeatText = '';
            if (alarmItem.repeatDays && alarmItem.repeatDays.length > 0) {
                const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
                const repeatDaysList = alarmItem.repeatDays.map(day => dayNames[day]).join(', ');
                repeatText = `, 每周重复: ${repeatDaysList}`;
            }
            
            alarmElement.innerHTML = `
                <div class="alarm-info">
                    <div class="alarm-time">${alarmItem.time}</div>
                    <div class="alarm-details">${alarmItem.content}, ${alarmItem.voice === 'male' ? '男声' : '女声'}, ${durationText}${repeatText}</div>
                </div>
                <div class="toggle-btn ${alarmItem.active ? 'active' : ''}" onclick="toggleAlarm(${alarmItem.id})"></div>
            `;
            
            // 添加右键菜单功能
            alarmElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showConfirm('确定要删除这个闹钟吗？', '确认删除', function(confirmed) {
                    if (confirmed) {
                        deleteAlarm(alarmItem.id);
                    }
                });
            });
            
            alarmList.appendChild(alarmElement);
        }
        
        // 删除闹钟
        function deleteAlarm(alarmId) {
            // 找到闹钟索引
            const alarmIndex = alarms.findIndex(a => a.id === alarmId);
            if (alarmIndex === -1) return;
            
            // 清除闹钟定时器
            const alarmItem = alarms[alarmIndex];
            if (alarmItem.interval) {
                clearInterval(alarmItem.interval);
            }
            
            // 从数组中删除
            alarms.splice(alarmIndex, 1);
            
            // 从DOM中删除
            const alarmElement = document.getElementById(`alarm-${alarmId}`);
            if (alarmElement) {
                alarmElement.remove();
            }
            
            // 更新下一个闹钟信息
            updateNextAlarmInfo();
        }
        
        // 切换步骤状态
        function toggleStep(stepIndex) {
            // 切换步骤的开关状态
            const stepItems = document.querySelectorAll('.step-item');
            if (stepItems[stepIndex]) {
                const toggleBtn = stepItems[stepIndex].querySelector('.toggle-btn');
                if (toggleBtn) {
                    const isActive = toggleBtn.classList.contains('active');
                    
                    if (isActive) {
                        // 关闭步骤
                        toggleBtn.classList.remove('active');
                    } else {
                        // 开启步骤
                        toggleBtn.classList.add('active');
                    }
                }
            }
        }
        
        // 切换闹钟状态
        function toggleAlarm(alarmId) {
            const alarmItem = alarms.find(a => a.id === alarmId);
            if (!alarmItem) return;
            
            const toggleElement = document.querySelector(`#alarm-${alarmId} .toggle-btn`);
            if (!toggleElement) return;
            
            const isActive = toggleElement.classList.contains('active');
            
            if (isActive) {
                // 关闭闹钟
                clearInterval(alarmItem.interval);
                toggleElement.classList.remove('active');
                alarmItem.active = false;
            } else {
                // 开启闹钟
                startAlarm(alarmItem);
                toggleElement.classList.add('active');
                alarmItem.active = true;
            }
            
            // 更新下一个闹钟信息
            updateNextAlarmInfo();
        }
        
        // 开始闹钟
        function startAlarm(alarmItem) {
            console.log('启动闹钟:', alarmItem.content, '目标时间:', alarmItem.targetTime, '重复日期:', alarmItem.repeatDays);
            
            // 立即更新一次
            updateAlarm(alarmItem);
            
            // 设置定时器
            alarmItem.interval = setInterval(() => {
                updateAlarm(alarmItem);
            }, 1000);
        }
        
        // 更新闹钟
        function updateAlarm(alarmItem) {
            const now = new Date();
            const diff = alarmItem.targetTime - now;
            
            console.log('检查闹钟:', alarmItem.content, '目标时间:', alarmItem.targetTime, '当前时间:', now, '差值:', diff, 'active:', alarmItem.active, 'repeatDays:', alarmItem.repeatDays);
            
            if (diff <= 0 && alarmItem.active) {
                // 时间到
                console.log('闹钟触发！', 'repeatDays:', alarmItem.repeatDays);
                clearInterval(alarmItem.interval);
                
                // 计算所有步骤的总时间（用于音乐定时关闭）
                let totalStepsDuration = 0;
                if (alarmItem.steps && alarmItem.steps.length > 0) {
                    alarmItem.steps.forEach(step => {
                        totalStepsDuration += step.duration * 60 * 1000; // 转换为毫秒
                    });
                }
                
                // 计算音乐时长：如果duration为0（用户选择持续播放），保持为0；否则取较大值
                let musicDuration = alarmItem.duration;
                if (alarmItem.duration > 0 && totalStepsDuration > 0) {
                    // 如果有步骤，使用步骤总时长（确保音乐在语音提示播放完之前不停止）
                    musicDuration = Math.max(alarmItem.duration, totalStepsDuration);
                }
                
                // 播放音乐（如果duration为0，将持续播放直到用户点击停止按钮）
                playMusic(musicDuration);
                
                // 显示锁屏界面
                showLockScreen(alarmItem.content);
                
                // 自动打卡
                performAutoCheckin();
                
                // 处理闹钟触发后的逻辑（删除或重新设置）
                function handleAlarmAfterTrigger(alarmItem) {
                    // 如果有重复日期，重新设置闹钟到下一个重复日期
                    if (alarmItem.repeatDays && alarmItem.repeatDays.length > 0) {
                        const now = new Date();
                        const nextRepeatTime = new Date(alarmItem.targetTime);
                        
                        // 找到下一个重复的日期
                        let found = false;
                        for (let i = 1; i <= 7; i++) {
                            nextRepeatTime.setDate(nextRepeatTime.getDate() + 1);
                            if (alarmItem.repeatDays.includes(nextRepeatTime.getDay())) {
                                found = true;
                                break;
                            }
                        }
                        
                        if (found) {
                            alarmItem.targetTime = nextRepeatTime;
                            startAlarm(alarmItem);
                        }
                    } else {
                        // 没有重复日期的闹钟触发后删除
                        deleteAlarm(alarmItem.id);
                    }
                    
                    // 更新下一个闹钟信息
                    updateNextAlarmInfo();
                }
                
                // 检查是否有套餐步骤
                if (alarmItem.steps && alarmItem.steps.length > 0) {
                    // 按照套餐步骤进行语音提示
                    let currentStepIndex = 0;
                    
                    function playStepReminder() {
                        const step = alarmItem.steps[currentStepIndex];
                        // 播放语音提示
                        playVoiceReminder(`现在该做${step.name}`, alarmItem.voice);
                        
                        // 进入下一步
                        currentStepIndex++;
                        
                        // 如果还有步骤，设置定时器
                        if (currentStepIndex < alarmItem.steps.length) {
                            const nextStep = alarmItem.steps[currentStepIndex];
                            setTimeout(playStepReminder, nextStep.duration * 60 * 1000); // 转换为毫秒
                        } else {
                            // 所有步骤播放完成后再处理闹钟
                            setTimeout(function() {
                                handleAlarmAfterTrigger(alarmItem);
                            }, 3000); // 等待3秒后处理
                        }
                    }
                    
                    // 开始播放第一个步骤的语音提示
                    playStepReminder();
                } else {
                    // 没有套餐步骤，播放普通语音提示
                    playVoiceReminder(alarmItem.content, alarmItem.voice);
                    
                    // 等待语音提示播放完成后处理闹钟
                    setTimeout(function() {
                        handleAlarmAfterTrigger(alarmItem);
                    }, 3000); // 等待3秒后处理
                }
            }
        }
        
        // 播放语音提示
        function playVoiceReminder(content, voice) {
            console.log('播放语音提示:', content, voice);
            try {
                // 检查浏览器是否支持Web Speech API
                if (!window.speechSynthesis) {
                    console.error('浏览器不支持Web Speech API');
                    return;
                }
                
                // 停止之前的语音
                window.speechSynthesis.cancel();
                
                // 检查内容是否已经包含"现在"开头
                let text = content;
                if (!content.startsWith('现在')) {
                    text = `现在是${content}时间`;
                }
                console.log('语音提示内容:', text);
                
                // 创建语音实例
                const utterance = new SpeechSynthesisUtterance(text);
                
                // 设置语音类型
                utterance.lang = 'zh-CN';
                utterance.rate = 1.0; // 语速
                utterance.pitch = 1.0; // 音调
                utterance.volume = 1.0; // 音量
                
                // 获取语音列表
                let availableVoices = voicesList.length > 0 ? voicesList : window.speechSynthesis.getVoices();
                console.log('可用语音数量:', availableVoices.length);
                
                if (availableVoices.length > 0) {
                    let selectedVoice = null;
                    
                    if (voice === 'male') {
                        // 尝试找男声（更全面的搜索）
                        selectedVoice = availableVoices.find(v => 
                            v.gender === 'male' || 
                            v.name.toLowerCase().includes('male') || 
                            v.name.toLowerCase().includes('man') ||
                            v.name.toLowerCase().includes('男') ||
                            v.lang.includes('zh')
                        );
                    } else {
                        // 尝试找女声（更全面的搜索）
                        selectedVoice = availableVoices.find(v => 
                            v.gender === 'female' || 
                            v.name.toLowerCase().includes('female') || 
                            v.name.toLowerCase().includes('woman') ||
                            v.name.toLowerCase().includes('女') ||
                            v.lang.includes('zh')
                        );
                    }
                    
                    // 如果找不到指定性别的语音，使用第一个可用语音
                    if (!selectedVoice && availableVoices.length > 0) {
                        selectedVoice = availableVoices[0];
                        console.log('使用默认语音:', selectedVoice.name);
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        console.log('已选择语音:', selectedVoice.name, selectedVoice.lang);
                    }
                }
                
                // 播放三次
                let count = 0;
                const playNext = () => {
                    try {
                        window.speechSynthesis.speak(utterance);
                        console.log('语音播放次数:', count + 1);
                        count++;
                        if (count < 3) {
                            setTimeout(playNext, 1500);
                        }
                    } catch (error) {
                        console.error('语音播放失败:', error);
                    }
                };
                
                playNext();
            } catch (error) {
                console.error('语音提示失败:', error);
            }
        }
        
        function playMusic(duration) {
            if (isPlaying) {
                // 停止音乐
                audioPlayer.pause();
                audioPlayer.src = '';
                isPlaying = false;
                
                // 清除定时关闭计时器
                if (musicTimer) {
                    clearTimeout(musicTimer);
                    musicTimer = null;
                }
            } else {
                // 开始播放音乐
                playCurrentMusic();
                isPlaying = true;
                
                // 设置定时关闭
                if (duration > 0) {
                    // 清除之前的计时器
                    if (musicTimer) {
                        clearTimeout(musicTimer);
                    }
                    
                    // 设置新的计时器
                    musicTimer = setTimeout(function() {
                        playMusic(0); // 停止音乐
                    }, duration);
                }
            }
        }
        
        // 播放当前音乐
        function playCurrentMusic() {
            const music = musicList[currentMusicIndex];
            console.log('播放音乐:', music.title, music.url);
            // 确保音乐路径正确
            let musicUrl = music.url;
            if (musicUrl.startsWith('./')) {
                musicUrl = musicUrl.substring(2);
            }
            audioPlayer.src = musicUrl + '?t=' + new Date().getTime(); // 防止缓存
            
            // 尝试播放音乐
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('音乐开始播放');
                }).catch(error => {
                    console.error('音乐播放失败:', error);
                    // 尝试使用用户交互来解锁音频上下文
                    document.addEventListener('click', function resumeAudio() {
                        audioPlayer.play().catch(e => console.error('重试播放失败:', e));
                        document.removeEventListener('click', resumeAudio);
                    }, { once: true });
                });
            }
        }
        
        // 音乐结束时自动播放下一首
        audioPlayer.addEventListener('ended', function() {
            currentMusicIndex = (currentMusicIndex + 1) % musicList.length;
            playCurrentMusic();
        });
        
        // 选择套餐函数
        function selectPackage(packageId) {
            // 检查是否已经选择了一个套餐
            if (currentPackage.id) {
                // 显示确认对话框
                showConfirm('您已选择一个套餐，是否更换为新套餐？', '确认更换', function(confirmed) {
                    if (!confirmed) {
                        // 用户取消，直接返回
                        return;
                    }
                    proceedWithPackageSelection(packageId);
                });
            } else {
                proceedWithPackageSelection(packageId);
            }
        }
        
        function proceedWithPackageSelection(packageId) {
            
            // 根据套餐设置默认值
            let content = '';
            let durationMinutes = 0;
            
            if (packageId === 'package1') {
                content = '超累也能做';
                durationMinutes = 5; // 5分钟
            } else if (packageId === 'package2') {
                content = '考前焦虑';
                durationMinutes = 10; // 10分钟
            } else if (packageId === 'package3') {
                content = '睡眠质量';
                durationMinutes = 15; // 15分钟
            } else if (packageId === 'package4') {
                content = '拉伸放松';
                durationMinutes = 8; // 8分钟
            }
            
            // 存储当前套餐信息
            currentPackage = {
                id: packageId,
                content: content,
                durationMinutes: durationMinutes,
                steps: packageSteps[packageId]
            };
            
            // 删除现有的套餐闹钟（如果存在）
            // 这里我们假设套餐闹钟的content包含套餐名称
            for (let i = alarms.length - 1; i >= 0; i--) {
                if (alarms[i].content.includes('套餐')) {
                    // 清除闹钟定时器
                    if (alarms[i].interval) {
                        clearInterval(alarms[i].interval);
                    }
                    // 从DOM中删除
                    const alarmElement = document.getElementById(`alarm-${alarms[i].id}`);
                    if (alarmElement) {
                        alarmElement.remove();
                    }
                    // 从数组中删除
                    alarms.splice(i, 1);
                }
            }
            
            // 找到app-container
            const appContainer = document.querySelector('.app-container');
            
            // 移除现有的步骤容器（如果存在）
            const existingStepsContainer = document.getElementById('steps-container');
            if (existingStepsContainer) {
                // 确保元素存在且有父元素
                if (existingStepsContainer.parentNode) {
                    existingStepsContainer.parentNode.removeChild(existingStepsContainer);
                }
            }
            
            // 创建新的步骤容器
            const stepsContainer = document.createElement('div');
            stepsContainer.id = 'steps-container';
            stepsContainer.style.marginTop = '20px';
            stepsContainer.style.padding = '15px';
            stepsContainer.style.background = '#f9f9f9';
            stepsContainer.style.borderRadius = '12px';
            
            // 创建步骤标题
            const stepsTitle = document.createElement('div');
            stepsTitle.style.color = '#333';
            stepsTitle.style.marginBottom = '15px';
            stepsTitle.style.fontSize = '1.1em';
            stepsTitle.style.fontWeight = 'bold';
            stepsTitle.textContent = '套餐步骤';
            stepsContainer.appendChild(stepsTitle);
            
            // 添加步骤作为分开的div
            currentPackage.steps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-item';
                stepDiv.innerHTML = `
                    <div class="step-info">
                        <div class="step-time">${index + 1}</div>
                        <div class="step-details">${step.name}, ${step.duration}分钟</div>
                    </div>
                    <div class="toggle-btn active" onclick="toggleStep(${index})"></div>
                `;
                stepsContainer.appendChild(stepDiv);
            });
            
            // 插入到app-container的末尾
            appContainer.appendChild(stepsContainer);
            
            // 打开添加闹钟弹窗
            addAlarmModal.style.display = 'flex';
            
            // 设置默认值
            reminderContent.value = content;
            reminderHours.value = '00';
            reminderMinutes.value = '00';
            
            // 设置定时关闭时间
            const durationHours = Math.floor(durationMinutes / 60);
            const durationMins = durationMinutes % 60;
            
            // 格式化为两位数
            const formattedHours = durationHours.toString().padStart(2, '0');
            const formattedMinutes = durationMins.toString().padStart(2, '0');
            
            // 设置select的值
            musicHours.value = formattedHours;
            musicMinutes.value = formattedMinutes;
        }
        
        // 开始设置按钮点击事件
        const startPackageBtn = document.getElementById('start-package-btn');
        if (startPackageBtn) {
            startPackageBtn.addEventListener('click', function() {
                // 隐藏套餐步骤容器
                const packageStepsContainer = document.getElementById('package-steps-container');
                if (packageStepsContainer) {
                    packageStepsContainer.style.display = 'none';
                }
                
                // 打开添加闹钟弹窗
                addAlarmModal.style.display = 'flex';
                
                // 设置默认值
                reminderContent.value = currentPackage.content;
                reminderHours.value = '00';
                reminderMinutes.value = '00';
                
                // 设置定时关闭时间
                const durationHours = Math.floor(currentPackage.durationMinutes / 60);
                const durationMins = currentPackage.durationMinutes % 60;
                
                // 格式化为两位数
                const formattedHours = durationHours.toString().padStart(2, '0');
                const formattedMinutes = durationMins.toString().padStart(2, '0');
                
                // 设置select的值
                musicHours.value = formattedHours;
                musicMinutes.value = formattedMinutes;
            });
        }
        
        // 存储语音列表加载状态
        let voicesLoaded = false;
        let voicesList = [];
        
        // 初始化 Web Speech API 语音列表
        window.speechSynthesis.onvoiceschanged = function() {
            console.log('语音列表已加载');
            voicesList = window.speechSynthesis.getVoices();
            voicesLoaded = true;
            console.log('可用语音数量:', voicesList.length);
            console.log('语音列表:', voicesList);
        };
        
        // 预加载语音列表
        voicesList = window.speechSynthesis.getVoices();
        if (voicesList.length > 0) {
            voicesLoaded = true;
            console.log('初始语音列表:', voicesList);
        }
        
        // ESP32S3导入函数
        async function importToESP32S3() {
            if (alarms.length === 0) {
                alert('请先添加闹钟');
                return;
            }
            
            // 检查浏览器是否支持Web Serial API
            if (!navigator.serial) {
                alert('您的浏览器不支持Web Serial API，请使用Chrome或Edge浏览器');
                return;
            }
            
            try {
                // 详细的用户指导
                // 详细的用户指导
                if (confirm('请确保：\n1. ESP32S3已正确连接到电脑\n2. ESP32S3已正确安装驱动程序\n3. ESP32S3处于可访问状态\n\n点击"确定"后，会弹出串口选择对话框，请选择ESP32S3设备。')) {
                    // 请求串口连接
                    console.log('请求串口连接...');
                    const port = await navigator.serial.requestPort();
                    console.log('已选择串口:', port.name);
                    
                    await port.open({ baudRate: 115200 });
                    console.log('串口已打开，波特率: 115200');
                    
                    // 收集所有闹钟信息
                    const esp32Data = {
                        alarms: alarms.map(alarm => ({
                            id: alarm.id,
                            content: alarm.content,
                            time: alarm.time,
                            voice: alarm.voice,
                            duration: alarm.duration,
                            hours: alarm.hours,
                            minutes: alarm.minutes,
                            targetTime: alarm.targetTime.toISOString(),
                            active: alarm.active,
                            steps: alarm.steps
                        })),
                        timestamp: new Date().toISOString(),
                        oledDisplay: {
                            enabled: true,
                            type: 'SSD1306',
                            size: '0.96inch',
                            content: {
                                title: '晚安小花',
                                alarmCount: alarms.filter(a => a.active).length,
                                nextAlarm: alarms.filter(a => a.active).sort((a, b) => a.time.localeCompare(b.time))[0]?.time || '无',
                                status: '已导入'
                            }
                        }
                    };
                    
                    // 将数据转换为JSON字符串并添加结束标记
                    const dataString = JSON.stringify(esp32Data) + '\n';
                    console.log('发送数据长度:', dataString.length, '字符');
                    
                    // 创建文本编码器
                    const encoder = new TextEncoder();
                    const dataArray = encoder.encode(dataString);
                    
                    // 获取写入器并发送数据
                    const writer = port.writable.getWriter();
                    await writer.write(dataArray);
                    writer.releaseLock();
                    console.log('数据发送成功');
                    
                    // 关闭串口连接
                    await port.close();
                    console.log('串口已关闭');
                    
                    // 显示导入成功的提示
                    alert('成功导入到ESP32S3！\n\n闹钟信息已发送到OLED显示屏。\n\n如果导入后没有声音，请点击页面上的"测试音乐"按钮验证音乐播放功能是否正常。');
                    console.log('导入到ESP32S3的数据:', esp32Data);
                    
                    // 导入完成后检查音乐播放状态
                    setTimeout(() => {
                        console.log('导入完成后音乐播放状态检查:');
                        console.log('音频元素:', audioPlayer);
                        console.log('音频元素就绪状态:', audioPlayer.readyState);
                    }, 2000);
                }
            } catch (error) {
                console.error('导入到ESP32S3失败:', error);
                
                if (error.name === 'NotFoundError') {
                    alert('导入到ESP32S3失败: \n1. 请确保ESP32S3已正确连接到电脑\n2. 请确保ESP32S3已正确安装驱动程序\n3. 请确保ESP32S3处于可访问状态\n4. 在弹出的对话框中选择正确的ESP32S3设备');
                } else if (error.name === 'SecurityError') {
                    alert('导入到ESP32S3失败: 浏览器不允许访问串口，请检查浏览器权限设置');
                } else if (error.name === 'AbortError') {
                    alert('导入到ESP32S3失败: 串口连接请求被取消');
                } else {
                    alert('导入到ESP32S3失败: ' + error.message);
                }
            }
        }
        
        // 为ESP32S3导入按钮添加点击事件
        const espImportBtn = document.getElementById('esp-import-btn');
        if (espImportBtn) {
            espImportBtn.addEventListener('click', importToESP32S3);
        }
        
        // 测试音乐播放功能
        function testMusicPlayback() {
            console.log('测试音乐播放...');
            try {
                // 检查音频元素
                console.log('音频元素:', audioPlayer);
                console.log('音频元素就绪状态:', audioPlayer.readyState);
                
                // 检查音乐列表
                console.log('音乐列表:', musicList);
                console.log('当前音乐索引:', currentMusicIndex);
                
                // 直接测试音乐播放
                playCurrentMusic();
                
                // 检查播放状态
                setTimeout(() => {
                    console.log('音乐播放状态:', audioPlayer.paused ? '暂停' : '播放中');
                    console.log('音频错误:', audioPlayer.error);
                }, 1000);
                
                alert('音乐播放测试已启动，请检查是否有声音\n\n详细信息请查看浏览器控制台');
                console.log('音乐播放测试已启动');
            } catch (error) {
                console.error('音乐播放测试失败:', error);
                alert('音乐播放测试失败: ' + error.message);
            }
        }
        
        // 停止音乐播放功能
        function stopMusicPlayback() {
            console.log('停止音乐播放...');
            try {
                // 检查音频元素
                console.log('音频元素:', audioPlayer);
                
                // 停止音乐
                audioPlayer.pause();
                audioPlayer.src = '';
                isPlaying = false;
                
                // 清除定时关闭计时器
                if (musicTimer) {
                    clearTimeout(musicTimer);
                    musicTimer = null;
                }
                
                // 检查停止状态
                setTimeout(() => {
                    console.log('音乐停止状态:', audioPlayer.paused ? '已停止' : '仍在播放');
                }, 500);
                
                alert('音乐已停止播放\n\n详细信息请查看浏览器控制台');
                console.log('音乐已停止播放');
            } catch (error) {
                console.error('停止音乐播放失败:', error);
                alert('停止音乐播放失败: ' + error.message);
            }
        }
        
        // 测试语音提示功能
        function testVoicePlayback() {
            console.log('测试语音提示...');
            try {
                // 检查浏览器是否支持Web Speech API
                if (!window.speechSynthesis) {
                    alert('您的浏览器不支持Web Speech API，请使用Chrome或Edge浏览器');
                    return;
                }
                
                // 检查语音列表
                const voices = window.speechSynthesis.getVoices();
                console.log('可用语音列表:', voices);
                console.log('语音数量:', voices.length);
                
                if (voices.length === 0) {
                    alert('暂无可用于语音提示的语音，请稍后再试');
                    return;
                }
                
                // 测试语音提示
                playVoiceReminder('测试语音提示', 'female');
                
                alert('语音提示测试已启动，请检查是否有语音播放\n\n详细信息请查看浏览器控制台');
                console.log('语音提示测试已启动');
            } catch (error) {
                console.error('语音提示测试失败:', error);
                alert('语音提示测试失败: ' + error.message);
            }
        }
        
        // 自定义提示框功能
        let alertCallback = null;
        let isConfirmMode = false;
        
        // 保存原生alert函数
        const originalAlert = window.alert;
        
        function showAlert(message, title = '提示', callback = null) {
            const alertElement = document.getElementById('custom-alert');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertActions = document.getElementById('alert-actions');
            const alertCancel = document.getElementById('alert-cancel');
            const alertConfirm = document.getElementById('alert-confirm');
            
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertCallback = callback;
            isConfirmMode = false;
            
            // 显示单个确认按钮
            alertCancel.style.display = 'none';
            alertConfirm.style.display = 'inline-block';
            alertConfirm.textContent = '确定';
            
            // 先设置为可见
            alertElement.style.display = 'flex';
            
            // 强制浏览器重绘
            void alertElement.offsetWidth;
            
            // 然后添加active类触发动画
            alertElement.classList.add('active');
        }
        
        function showConfirm(message, title = '确认', callback = null) {
            const alertElement = document.getElementById('custom-alert');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertActions = document.getElementById('alert-actions');
            const alertCancel = document.getElementById('alert-cancel');
            const alertConfirm = document.getElementById('alert-confirm');
            
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertCallback = callback;
            isConfirmMode = true;
            
            // 显示两个按钮
            alertCancel.style.display = 'inline-block';
            alertConfirm.style.display = 'inline-block';
            alertCancel.textContent = '取消';
            alertConfirm.textContent = '确定';
            
            alertElement.classList.add('active');
        }
        
        function hideAlert() {
            const alertElement = document.getElementById('custom-alert');
            alertElement.classList.remove('active');
            // 延迟设置display为none，等待动画完成
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 300);
            alertCallback = null;
            isConfirmMode = false;
        }
        
        // 绑定提示框按钮事件
        document.getElementById('alert-confirm').addEventListener('click', function() {
            if (alertCallback && typeof alertCallback === 'function') {
                if (isConfirmMode) {
                    alertCallback(true);
                } else {
                    alertCallback();
                }
            }
            hideAlert();
        });
        
        document.getElementById('alert-cancel').addEventListener('click', function() {
            if (alertCallback && typeof alertCallback === 'function' && isConfirmMode) {
                alertCallback(false);
            }
            hideAlert();
        });
        
        // 锁屏功能
        let currentLockContent = '';
        
        function showLockScreen(content) {
            const lockScreen = document.getElementById('lock-screen');
            const lockTitle = document.getElementById('lock-screen-title');
            const lockMessage = document.getElementById('lock-screen-message');
            const lockEmoji = document.getElementById('lock-screen-emoji');
            const tabNavigation = document.querySelector('.tab-navigation');
            
            currentLockContent = content;
            lockTitle.textContent = `${content}时间到了`;
            lockMessage.textContent = '休息一下吧';
            lockEmoji.textContent = '⏰';
            
            // 隐藏标签页导航
            if (tabNavigation) {
                tabNavigation.style.display = 'none';
                console.log('标签页导航已隐藏');
            }
            
            lockScreen.classList.add('active');
            console.log('锁屏已显示');
        }
        
        function hideLockScreen() {
            const lockScreen = document.getElementById('lock-screen');
            const tabNavigation = document.querySelector('.tab-navigation');
            
            lockScreen.classList.remove('active');
            currentLockContent = '';
            
            // 恢复标签页导航
            if (tabNavigation) {
                tabNavigation.style.display = 'flex';
                console.log('标签页导航已恢复');
            }
            
            console.log('锁屏已隐藏');
        }
        
        // 绑定锁屏退出按钮事件（支持两种ID，兼容缓存问题）
        function bindExitButtonEvent() {
            console.log('开始绑定退出按钮事件');
            
            const exitBtn1 = document.getElementById('lock-screen-exit-btn');
            const exitBtn2 = document.getElementById('lock-exit-btn');
            
            console.log('退出按钮元素:', {
                lockScreenExitBtn: exitBtn1,
                lockExitBtn: exitBtn2
            });
            
            const handleExitClick = function() {
                console.log('退出按钮被点击');
                
                // 直接隐藏锁屏，不需要伤心表情
                hideLockScreen();
            };
            
            if (exitBtn1) {
                console.log('绑定lock-screen-exit-btn事件');
                exitBtn1.addEventListener('click', handleExitClick);
                // 添加内联onclick作为备用
                exitBtn1.onclick = handleExitClick;
            }
            
            if (exitBtn2) {
                console.log('绑定lock-exit-btn事件');
                exitBtn2.addEventListener('click', handleExitClick);
                // 添加内联onclick作为备用
                exitBtn2.onclick = handleExitClick;
            }
            
            console.log('退出按钮事件绑定完成');
        }
        
        // 页面加载完成后绑定事件
        window.addEventListener('load', function() {
            console.log('页面加载完成，绑定退出按钮事件');
            bindExitButtonEvent();
            
            // 为重复日期复选框添加事件监听
            const repeatCheckboxes = document.querySelectorAll('.repeat-day');
            repeatCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    console.log('复选框变更:', this.value, this.checked);
                    updateRepeatDisplay();
                });
            });
        });
        
        // 立即尝试绑定（如果DOM已经加载）
        setTimeout(bindExitButtonEvent, 1000); // 延迟1秒后绑定，确保DOM完全加载
        
        // 替换默认的alert和confirm函数
        window.alert = showAlert;
        window.confirm = function(message, callback) {
            showConfirm(message, '确认', callback);
        };
        
        // 启动应用
        function init() {
            // 每秒更新当前时间
            setInterval(updateCurrentTime, 1000);
            // 立即更新一次
            updateCurrentTime();
            
            // 初始化打卡功能
            generateCalendar();
            updateTodayStatus();
            calculateStats();
            
            // 当页面从后台返回时检查闹钟
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    console.log('页面从后台返回，检查闹钟');
                    alarms.forEach(function(alarmItem) {
                        if (alarmItem.active && alarmItem.interval) {
                            updateAlarm(alarmItem);
                        }
                    });
                }
            });
            
            // 移动端触摸优化
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');
                
                // 防止双击缩放
                document.addEventListener('dblclick', function(event) {
                    event.preventDefault();
                }, { passive: false });
                
                // 优化触摸响应
                const buttons = document.querySelectorAll('button, .toggle-btn, .package-btn, .modal-btn, .add-alarm-btn, .esp-import-btn, .alert-btn');
                buttons.forEach(button => {
                    button.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    }, { passive: true });
                    
                    button.addEventListener('touchend', function() {
                        this.classList.remove('touch-active');
                    }, { passive: true });
                });
            }
            
            // 检测PWA安装状态
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('PWA安装提示已触发');
            });
            
            window.addEventListener('appinstalled', () => {
                console.log('PWA已安装');
                deferredPrompt = null;
            });
        }
        
        let deferredPrompt = null;
        
        // 标签页切换功能
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有按钮的激活状态
            const allButtons = document.querySelectorAll('.tab-btn');
            allButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 显示选中的标签页
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                
                // 如果切换到打卡标签页，生成日历
                if (tabName === 'checkin') {
                    generateCalendar();
                }
            }
            
            // 激活对应的按钮
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                let targetText = '';
                if (tabName === 'software') {
                    targetText = '软件网页';
                } else if (tabName === 'checkin') {
                    targetText = '打卡';
                }
                if (btn.textContent.includes(targetText)) {
                    btn.classList.add('active');
                }
            });
            
            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log('切换到标签页:', tabName);
        }
        
        // 打卡功能
        let checkinData = [];
        let currentDate = new Date();
        
        function performCheckin() {
            console.log('开始执行打卡...');
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-CN');
            const timeStr = today.toLocaleTimeString('zh-CN');
            console.log('打卡日期:', dateStr, '时间:', timeStr);
            
            // 检查今天是否已打卡
            const todayCheckin = checkinData.find(item => item.date === dateStr);
            console.log('今日打卡记录:', todayCheckin);
            
            if (todayCheckin) {
                originalAlert('今天已经打卡过了！');
                return;
            }
            
            // 先显示成功提示（使用原生alert确保立即显示）
            originalAlert('打卡成功！继续保持良好的睡眠习惯！');
            console.log('打卡成功提示已显示');
            
            // 添加打卡记录
            const newCheckin = {
                date: dateStr,
                time: timeStr,
                timestamp: today.getTime()
            };
            
            checkinData.unshift(newCheckin);
            console.log('打卡数据已添加');
            
            // 更新UI
            generateCalendar();
            updateTodayStatus();
            calculateStats();
            console.log('UI已更新');
        }
        
        // 自动打卡函数（无提示）
        function performAutoCheckin() {
            console.log('执行自动打卡');
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-CN');
            const timeStr = today.toLocaleTimeString('zh-CN');
            
            // 检查今天是否已打卡
            const todayCheckin = checkinData.find(item => item.date === dateStr);
            
            if (todayCheckin) {
                console.log('今天已经打卡过了，跳过自动打卡');
                return;
            }
            
            // 添加打卡记录
            const newCheckin = {
                date: dateStr,
                time: timeStr,
                timestamp: today.getTime()
            };
            
            checkinData.unshift(newCheckin);
            
            // 更新UI
            generateCalendar();
            updateTodayStatus();
            calculateStats();
            
            console.log('自动打卡成功');
        }
        
        // 生成日历
        function generateCalendar() {
            console.log('开始生成日历...');
            const calendarGrid = document.getElementById('calendar-grid');
            const currentMonthElement = document.getElementById('current-month');
            
            if (!calendarGrid) {
                console.log('错误：找不到calendar-grid元素');
                return;
            }
            if (!currentMonthElement) {
                console.log('错误：找不到current-month元素');
                return;
            }
            
            console.log('找到日历元素，准备生成日期...');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            console.log(`生成日历: ${year}年${month + 1}月`);
            
            // 更新月份显示
            currentMonthElement.textContent = `${year}年${month + 1}月`;
            
            // 获取当月第一天
            const firstDay = new Date(year, month, 1);
            // 获取当月天数
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            // 获取第一天是星期几
            const startDay = firstDay.getDay();
            
            console.log(`当月天数: ${daysInMonth}, 第一天是星期: ${startDay}`);
            
            // 清空日历
            calendarGrid.innerHTML = '';
            console.log('日历网格已清空');
            
            // 添加空白格子
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.style.visibility = 'hidden';
                calendarGrid.appendChild(emptyCell);
            }
            
            console.log(`添加了${startDay}个空白格子`);
            
            // 添加日期格子
            for (let day = 1; day <= daysInMonth; day++) {
                const dateCell = document.createElement('div');
                const cellDate = new Date(year, month, day);
                const cellDateStr = cellDate.toLocaleDateString('zh-CN');
                const isToday = isSameDay(cellDate, new Date());
                const isChecked = isCheckedIn(cellDateStr);
                
                // 设置格子样式
                dateCell.style.padding = '10px';
                dateCell.style.borderRadius = '8px';
                dateCell.style.textAlign = 'center';
                dateCell.style.border = '1px solid #e0e0e0';
                dateCell.style.background = 'white';
                dateCell.style.minHeight = '60px';
                dateCell.style.display = 'flex';
                dateCell.style.flexDirection = 'column';
                dateCell.style.alignItems = 'center';
                dateCell.style.justifyContent = 'center';
                
                // 今天的特殊样式
                if (isToday) {
                    dateCell.style.background = '#e3f2fd';
                    dateCell.style.border = '2px solid #2196f3';
                }
                
                // 日期数字
                const dayElement = document.createElement('div');
                dayElement.textContent = day;
                dayElement.style.fontSize = '1.1em';
                dayElement.style.fontWeight = 'bold';
                
                // 设置日期数字颜色：只有今天的日期为红色，其他为黑色
                if (isToday) {
                    dayElement.style.color = '#ff6b6b';
                } else {
                    dayElement.style.color = '#000000';
                }
                
                // 打卡状态
                if (isChecked) {
                    const checkElement = document.createElement('div');
                    checkElement.innerHTML = '✅';
                    checkElement.style.fontSize = '1.2em';
                    checkElement.style.marginTop = '5px';
                    dateCell.appendChild(dayElement);
                    dateCell.appendChild(checkElement);
                } else {
                    dateCell.appendChild(dayElement);
                }
                
                calendarGrid.appendChild(dateCell);
            }
            
            console.log(`日历生成完成！添加了${daysInMonth}个日期格子`);
            
            // 高亮今天的星期标题
            const today = new Date();
            const todayDayOfWeek = today.getDay();
            const weekdays = document.querySelectorAll('#weekdays > div');
            weekdays.forEach((day, index) => {
                if (index === todayDayOfWeek) {
                    // 今天的星期：红色背景，白色文字
                    day.style.background = '#ff6b6b';
                    day.style.color = 'white';
                    day.style.borderRadius = '8px';
                    day.style.padding = '8px';
                } else {
                    day.style.background = 'transparent';
                    day.style.borderRadius = '0';
                    day.style.padding = '0';
                    // 其他星期：黑色
                    day.style.color = '#000000';
                }
            });
        }
        
        // 切换月份
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
        }
        
        // 上一个月
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }
        
        // 下一个月
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }
        
        // 更新今日状态
        function updateTodayStatus() {
            const todayMessage = document.getElementById('today-message');
            const checkinBtn = document.getElementById('checkin-btn');
            
            if (!todayMessage || !checkinBtn) return;
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-CN');
            const todayCheckin = checkinData.find(item => item.date === dateStr);
            
            if (todayCheckin) {
                todayMessage.innerHTML = `✅ 已于 <strong>${todayCheckin.time}</strong> 打卡`;
                checkinBtn.textContent = '已打卡';
                checkinBtn.disabled = true;
                checkinBtn.style.background = '#4caf50';
            } else {
                todayMessage.textContent = '还未打卡';
                checkinBtn.textContent = '立即打卡';
                checkinBtn.disabled = false;
                checkinBtn.style.background = '#2196f3';
            }
        }
        
        // 计算打卡统计
        function calculateStats() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // 本月打卡天数
            const monthlyCheckins = checkinData.filter(item => {
                const checkinDate = new Date(item.date);
                return checkinDate.getMonth() === currentMonth && checkinDate.getFullYear() === currentYear;
            }).length;
            
            // 计算连续打卡天数
            let streak = 0;
            let checkDate = new Date();
            
            while (true) {
                const dateStr = checkDate.toLocaleDateString('zh-CN');
                const hasCheckin = checkinData.some(item => item.date === dateStr);
                
                if (hasCheckin) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            // 计算完成率
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const completionRate = Math.round((monthlyCheckins / daysInMonth) * 100);
            
            // 更新统计显示
            const statsElements = document.querySelectorAll('#checkin-stats > div');
            if (statsElements[0]) statsElements[0].querySelector('div').textContent = monthlyCheckins;
            if (statsElements[1]) statsElements[1].querySelector('div').textContent = streak;
            if (statsElements[2]) statsElements[2].querySelector('div').textContent = `${completionRate}%`;
        }
        
        // 检查某一天是否打卡
        function isCheckedIn(dateStr) {
            return checkinData.some(item => item.date === dateStr);
        }
        
        // 检查两个日期是否是同一天
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        
        // 启动应用
        init();
    </script>
    
    </div>
    

    
    <!-- 打卡标签页 -->
    <div id="checkin-tab" class="tab-content">
        <h1>每日打卡</h1>
        
        <div class="app-container" style="max-width: 600px;">
            <div style="padding: 20px;">
                <!-- 日历导航 -->
                <div id="calendar-nav" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button onclick="changeMonth(-1)" style="background: #f5f5f5; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 1em;">‹</button>
                    <h2 id="current-month" style="color: #333; margin: 0; font-size: 1.3em;"></h2>
                    <button onclick="changeMonth(1)" style="background: #f5f5f5; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 1em;">›</button>
                </div>
                
                <!-- 星期标题 -->
                <div id="weekdays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 10px;">
                    <div id="weekday-0" style="text-align: center; font-weight: bold; color: #000000; font-size: 0.9em;">日</div>
                    <div id="weekday-1" style="text-align: center; font-weight: bold; color: #000000; font-size: 0.9em;">一</div>
                    <div id="weekday-2" style="text-align: center; font-weight: bold; color: #000000; font-size: 0.9em;">二</div>
                    <div id="weekday-3" style="text-align: center; font-weight: bold; color: #000000; font-size: 0.9em;">三</div>
                    <div id="weekday-4" style="text-align: center; font-weight: bold; color: #000000; font-size: 0.9em;">四</div>
                    <div id="weekday-5" style="text-align: center; font-weight: bold; color: #000000; font-size: 0.9em;">五</div>
                    <div id="weekday-6" style="text-align: center; font-weight: bold; color: #000000; font-size: 0.9em;">六</div>
                </div>
                
                <!-- 日历网格 -->
                <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                    <!-- 日期格子将通过JavaScript动态生成 -->
                </div>
                
                <!-- 今日状态 -->
                <div id="today-status" style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 12px;">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">今日状态</h3>
                    <div id="today-message" style="font-size: 1.1em; margin-bottom: 20px;"></div>
                    <button id="checkin-btn" onclick="performCheckin()" style="background: #2196f3; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4); transition: all 0.3s ease;">
                        立即打卡
                    </button>
                </div>
                
                <!-- 打卡统计 -->
                <div id="checkin-stats" style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 5px;">0</div>
                        <div style="font-size: 0.9em;">本月打卡</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 5px;">0</div>
                        <div style="font-size: 0.9em;">连续打卡</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 5px;">0%</div>
                        <div style="font-size: 0.9em;">完成率</div>
                    </div>
                </div>
                

            </div>
        </div>
    </div>
    
    <script>
        // 豆包 API 配置
        const DOBAO_API_KEY = '619f5b95-be68-4bd8-a542-7e8e367ff1f8'; // 豆包 API密钥
        const DOBAO_API_NAME = 'api-key-20260213174215'; // 豆包 API密钥名称
        const DOBAO_API_ENDPOINT = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions'; // 豆包 API端点
        const DOBAO_MODEL = 'doubao-seed-code'; // 豆包模型名称（使用编程模型）
        
        // 对话历史管理
        let conversationHistory = [];
        
        // 发送消息函数
        function sendMessage() {
            const userInput = document.getElementById('user-input');
            const chatHistory = document.getElementById('chat-history');
            const message = userInput.value.trim();
            
            if (!message) return;
            
            // 添加用户消息到对话历史
            addMessage('user', message);
            
            // 添加到对话历史数组
            conversationHistory.push({
                role: 'user',
                content: message
            });
            
            // 清空输入框
            userInput.value = '';
            
            // 显示正在输入状态
            addMessage('bot', '正在思考...', true);
            
            // 调用豆包 API 获取回复
            getDoubaoResponse().then(response => {
                // 移除正在输入状态
                const thinkingMessage = chatHistory.lastElementChild;
                if (thinkingMessage && thinkingMessage.dataset.thinking === 'true') {
                    thinkingMessage.remove();
                }
                
                // 添加机器人回复到对话历史
                addMessage('bot', response);
                
                // 添加到对话历史数组
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });
            }).catch(error => {
                // 移除正在输入状态
                const thinkingMessage = chatHistory.lastElementChild;
                if (thinkingMessage && thinkingMessage.dataset.thinking === 'true') {
                    thinkingMessage.remove();
                }
                
                // 显示详细错误消息
                addMessage('bot', `抱歉，豆包 API 调用失败: ${error.message || '未知错误'}`);
                console.error('豆包 API 错误:', error);
                console.error('API Key:', DOBAO_API_KEY);
                console.error('API Key Name:', DOBAO_API_NAME);
                console.error('Conversation History:', conversationHistory);
            });
        }
        
        // 添加消息到对话历史
        function addMessage(sender, text, isThinking = false) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            
            if (isThinking) {
                messageDiv.dataset.thinking = 'true';
                messageDiv.style.opacity = '0.7';
            }
            
            if (sender === 'user') {
                messageDiv.style.display = 'flex';
                messageDiv.style.justifyContent = 'flex-end';
                messageDiv.style.marginBottom = '10px';
                messageDiv.innerHTML = `
                    <div style="background: #2196f3; color: white; padding: 10px 15px; border-radius: 18px 18px 4px 18px; max-width: 80%;">
                        ${text}
                    </div>
                `;
            } else {
                messageDiv.style.display = 'flex';
                messageDiv.style.justifyContent = 'flex-start';
                messageDiv.style.marginBottom = '10px';
                messageDiv.innerHTML = `
                    <div style="background: #f5f5f5; color: #333; padding: 10px 15px; border-radius: 18px 18px 18px 4px; max-width: 80%;">
                        ${text}
                    </div>
                `;
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // 模拟 AI 回复功能
        async function getMockAIResponse() {
            console.log('使用模拟 AI 回复...');
            console.log('对话历史:', conversationHistory);
            
            // 预设回复模板
            const mockResponses = [
                '听起来您的睡眠质量不错！良好的睡眠对身体健康非常重要。您通常几点睡觉，几点起床呢？',
                '睡眠质量对我们的日常生活影响很大。您最近有什么影响睡眠的因素吗？比如压力、饮食或环境因素？',
                '保持规律的作息时间是改善睡眠质量的关键。您有尝试过什么方法来提高睡眠质量吗？',
                '良好的睡眠环境对睡眠质量有很大影响。您的卧室温度、光线和噪音水平如何？',
                '睡前放松活动如阅读、冥想或听轻音乐可以帮助改善睡眠质量。您有睡前放松的习惯吗？',
                '饮食也会影响睡眠质量。您晚上有喝咖啡、茶或其他含咖啡因的饮料吗？',
                '适当的运动可以提高睡眠质量，但避免在睡前剧烈运动。您通常什么时候运动？',
                '如果您经常失眠或睡眠质量差，建议咨询医生或专业的睡眠专家。您有考虑过寻求专业帮助吗？',
                '睡眠是身体恢复和修复的重要时间。确保每晚获得足够的睡眠时间对整体健康非常重要。',
                '每个人的睡眠需求不同，一般成年人需要7-9小时的睡眠。您通常每晚睡几个小时？'
            ];
            
            // 基于对话历史生成回复
            let response = '';
            const lastMessage = conversationHistory[conversationHistory.length - 1]?.content || '';
            
            // 简单的关键词匹配
            if (lastMessage.includes('好') || lastMessage.includes('不错') || lastMessage.includes('很棒')) {
                response = '很高兴听到您睡得好！保持良好的睡眠习惯对身体健康非常重要。您有什么特别的睡眠习惯吗？';
            } else if (lastMessage.includes('差') || lastMessage.includes('不好') || lastMessage.includes('失眠')) {
                response = '很抱歉听到您睡眠质量不好。失眠可能由多种因素引起，如压力、焦虑或环境因素。您有尝试过什么方法来改善睡眠吗？';
            } else if (lastMessage.includes('几点') || lastMessage.includes('时间')) {
                response = '睡眠时间表的一致性对睡眠质量非常重要。建议每天在相同的时间睡觉和起床，包括周末。您通常的作息时间是怎样的？';
            } else if (lastMessage.includes('方法') || lastMessage.includes('建议')) {
                response = '以下是一些改善睡眠质量的建议：保持规律的作息时间、创建舒适的睡眠环境、睡前避免咖啡因和电子设备、进行放松活动如阅读或冥想、适当运动但避免睡前剧烈运动。';
            } else {
                // 随机选择一个预设回复
                response = mockResponses[Math.floor(Math.random() * mockResponses.length)];
            }
            
            console.log('模拟 AI 回复:', response);
            
            // 模拟网络延迟
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            return response;
        }
        
        // 初始化对话
        function initChat() {
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = '';
            conversationHistory = [];
            addMessage('bot', '晚上好！我是您的睡眠质量评估助手。您今天睡得好吗？');
        }
        
        // 页面加载完成后初始化对话
        window.addEventListener('load', function() {
            // 当切换到打卡标签页时初始化对话
            const checkinTab = document.getElementById('checkin-tab');
            if (checkinTab) {
                // 监听标签页切换
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        if (this.textContent.includes('打卡')) {
                            setTimeout(initChat, 100);
                        }
                    });
                });
                
                // 如果当前已经在打卡标签页，直接初始化
                if (checkinTab.classList.contains('active')) {
                    initChat();
                }
            }
        });
        
        // 回车发送消息
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'user-input') {
                sendMessage();
            }
        });
        
        // 调用豆包 API 获取回复
        async function getDoubaoResponse() {
            try {
                console.log('开始调用豆包 API...');
                console.log('API Key:', DOBAO_API_KEY);
                console.log('API Key Name:', DOBAO_API_NAME);
                console.log('API Endpoint:', DOBAO_API_ENDPOINT);
                console.log('模型名称:', DOBAO_MODEL);
                
                const requestData = {
                    model: DOBAO_MODEL,
                    messages: [
                        {
                            role: 'system',
                            content: '你是一个睡眠质量评估助手，负责回答用户关于睡眠的问题，并提供相关建议。你的回答应该友好、专业，并且能够根据用户的回答提出进一步的问题，引导用户分享更多关于睡眠的信息。'
                        },
                        ...conversationHistory
                    ],
                    temperature: 0.7,
                    max_tokens: 1000,
                    stream: false
                };
                
                console.log('请求数据:', requestData);
                
                const response = await fetch(DOBAO_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DOBAO_API_KEY}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('响应状态:', response.status);
                console.log('响应头:', response.headers);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('错误响应数据:', errorData);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error?.message || '未知错误'}`);
                }
                
                const data = await response.json();
                console.log('成功响应数据:', data);
                return data.choices[0].message.content;
            } catch (error) {
                console.error('豆包 API 调用失败:', error);
                throw error;
            }
        }
    </script>
</body>
</html>